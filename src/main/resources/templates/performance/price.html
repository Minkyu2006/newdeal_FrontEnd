<!DOCTYPE html>
<html lang="ko"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="layout/default2">

<!-- 사용자 CSS 추가 -->
<th:block layout:fragment="css">
	
</th:block>

<!-- 사용자 스크립트 추가 -->
<th:block layout:fragment="script">
 	<script>
		$(function() {
			$("input:text[numberOnly]").on("keyup", function() {
				$(this).val($(this).val().replace(/[^0-9]/g,""));
			});

			$("#saveBtn").on('click',function(){
				save();
			});

			callList(1);
			$("#searchBtn").on('click',function(){
				callList(1);
			});

		});

		function save(){
			JWT_Get();

			if (accessToken == null && refreshToken == null && insert_id == null) {
				alertCaution("토큰이 만료되었습니다.<BR>다시 로그인해주세요.", 2);
			} else if (accessToken == null) {
				refreshTokenCookie();
			} else {

				let url;

				const params = {
					piYear: $("#piYear").val(),
					piPrice: $("#piPrice").val()
				};

				url = $("#backend_protocol").val() + "://" + $("#backend_url").val() + "/api/price/save"; // 호출할 백엔드 API

				$.ajax({
					url: url,
					type: 'post',
					data: params,
					cache: false,
					beforeSend: function (xhr) {
						xhr.setRequestHeader("JWT_AccessToken", accessToken);
						xhr.setRequestHeader("insert_id",insert_id);
					},
					error: function (request) {
						if (request.status === 500) {
							// console.log("request.status : " + request.status + " => 500에러");
							alertCaution("500에러 재로그인 해주세요.", 2);
						} else {
							// console.log("request.status : " + request.status + " => 404에러");
							alertCaution("404에러 재로그인 해주세요.", 2);
						}
					},
					success: function (res) {
						if (res.status === 200) {
							$("#piYear").val("");
							$("#piPrice").val("");
							alertSuccess("물가배수를 등록했습니다.");
							callList(1);
						}else{
							if (request.err_msg2 === null) {
								alertCaution(request.err_msg, 1);
							} else {
								alertCaution(request.err_msg + "<br>" + request.err_msg2, 1);
							}
						}
					}
				});
			}
		}

		function callList(page){
			JWT_Get();

			if (accessToken == null && refreshToken == null && insert_id == null) {
				// console.log("callinfo(userid)함수 : 토큰&리플레시&로그인한아이디 Null");
				alertCaution("토큰이 만료되었습니다.<BR>다시 로그인해주세요.", 2);
			} else if (accessToken == null) {
				refreshTokenCookie();
			} else {

				let url;

				page = page - 1;
				if (page < 0) page = 0

				const perPage = 10;
				const perArea = 5;
				let totCnt = 0;

				const $tableListYearCost = $('#tableListYearCost');
				const $totalCnt = $('#totalCnt');

				const params = {
					piYearSearch: $("#piYearSearch").val(),
					piPriceSearch: $("#piPriceSearch").val()
				};

				$tableListYearCost.empty().append('<tr ><td colspan="3" align = "center">조회 중</td></tr>');
				$totalCnt.text('0');

				url = $("#backend_protocol").val() + "://" + $("#backend_url").val() + "/api/price/list"; // 호출할 백엔드 API

				$.ajax({
					url: url + '?size=' + perPage + '&page=' + page,
					type: 'GET',
					data: params,
					cache: false,
					error: function (request) {
						ajaxErrorMsg(request);
					},
					success: function (res) {
						console.log("리스트출력");
						if (res.status === 200) {
							//화면 출력
							totCnt = res.total_rows;
							$("#pricePaging").jqueryPager({
								pageSize: perPage,
								pageBlock: perArea,
								currentPage: page + 1,
								pageTotal: totCnt,
								clickEvent: 'callList'
							});

							if (totCnt === 0) {
								$tableListYearCost.empty().append('<tr class="t-c"><td colspan="3" align="center">조회된 데이터가 없습니다.</td></tr>');
								return;
							}

							$totalCnt.text(totCnt);
							let html = '';
							$.each(res.datalist, function (key, value) {
								html += '<tr>';
									html += '<td >' + echoNull2Blank(value.piYear) + '</td>';
									html += '<td >' + echoNull2Blank(value.piPrice) + '</td>';
									html += '<td ><button class="c-button" onclick="del(\'' + echoNull2Blank(value.id) + '\');">삭제</button></td>';
								html += '</tr>';
							});
							$tableListYearCost.html(html);
						}
					}
				});
			}
		}

		function del(id){
			JWT_Get();

			if (accessToken == null && refreshToken == null && insert_id == null) {
				alertCaution("토큰이 만료되었습니다.<BR>다시 로그인해주세요.", 2);
			} else if (accessToken == null) {
				refreshTokenCookie();
			} else {

				let url;

				const params = {
					id: id
				};

				url = $("#backend_protocol").val() + "://" + $("#backend_url").val() + "/api/price/del"; // 호출할 백엔드 API

				$.ajax({
					url: url,
					type: 'post',
					data: params,
					cache: false,
					error: function (request) {
						ajaxErrorMsg(request);
					},
					success: function (res) {
						console.log("리스트출력");
						if (res.status === 200) {
							alertSuccess("삭제가 완료되었습니다.");
							callList(1);
						}
					}
				});
			}
		}

		//한글을 지우는 함수
		function delHangle(evt){
			var objTarget = evt.srcElement || evt.target;
			var _value = event.srcElement.value;
			if(/[ㄱ-ㅎㅏ-ㅡ가-핳]/g.test(_value)) {
				objTarget.value = null;
			}
		}
		// 소수점한개로 제한한 실수값입력할수있게하는 함수
		function isNumberKey(evt) {
			const charCode = (evt.which) ? evt.which : event.keyCode;
			const _value = event.srcElement.value;
			if (event.keyCode < 48 || event.keyCode > 57) {
				if (event.keyCode !== 46) {
					return false;
				}
			}
			// 소수점(.)이 두번 이상 나오지 못하게
			const _pattern0 = /^\d*[.]\d*$/;
			if (_pattern0.test(_value)) {
				if (charCode === 46) {
					return false;
				}
			}
			// 소수점 둘째자리까지만 입력가능
			const _pattern2 = /^\d*[.]\d{2}$/;
			if (_pattern2.test(_value)) {
				return false;
			}
		}

	</script>
</th:block>

<div layout:fragment="content" class="content">
	<input type="hidden" id="backend_url" th:value="${backend_url}" />
	<input type="hidden" id="backend_protocol" th:value="${backend_protocol}" />
	<div class="content__inner">
		<h2 class="content__heading">물가배수 등록 및 조회</h2>
		<section class="section">
			<article class="article">
				<div class="article__head">
					<h3 class="article__heading">물가배수 등록</h3>
				</div>
				<div class="article__body">
					<table class="c-table">
						<colgroup>
							<col />
							<col />
							<col />
							<col />
						</colgroup>
						<tbody>
							<tr>
								<th>년도</th>
								<td>
									<div class="c-text">
										<input type="text" id="piYear" class="c-text__input" maxlength='4' numberOnly />
									</div>
								</td>
								<th>환산율</th>
								<td>
									<div class="c-text">
										<input type="text" id="piPrice" class="c-text__input" onkeypress="return isNumberKey(event)" onkeyup="return delHangle(event)" />
									</div>
								</td>
								<td>
									<div class="c-function__group c-function__group--right">
										<div class="c-function__item"><button class="c-button c-button--point" id="saveBtn">저장</button></div>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</article>
		</section>
		
		<section class="section">
			<article class="article">
				<div class="article__head">
					<h3 class="article__heading">물가배수 조회</h3>
				</div>
				<div class="article__body">
					<div class="l-float-heading">
						<div class="l-float-heading--left">
							<h4 class="article__head">검색조건<span class="article__head-caption">(수정하려면 해당라인을 클릭후, 저장버튼을 누르세요.)</span></h4>
						</div>
					</div>
					<table class="c-table">
						<colgroup>
							<col />
							<col />
							<col />
							<col />
							<col style="width: 60px;" />
						</colgroup>
						<tbody>
							<tr>
								<th>년도</th>
								<td>
									<div class="c-text">
										<input type="text" id="piYearSearch" class="c-text__input" maxlength='4' numberOnly />
									</div>
								</td>
								<th>환산율</th>
								<td>
									<div class="c-text">
										<input type="text" id="piPriceSearch" class="c-text__input" onkeypress="return isNumberKey(event)" onkeyup="return delHangle(event)" />
									</div>
								</td>
								<td>
									<button class="c-button c-button--point" id="searchBtn">조회</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</article>
			
			<article class="article">
				<div class="article__body">
					<table class="c-table">
						<colgroup>
							<col />
							<col />
							<col style="width: 60px;" />
						</colgroup>
						<thead>
							<tr>
								<th>년도</th>
								<th>환산율</th>
								<th></th>
							</tr>
						</thead>
						<tbody id="tableListYearCost">
							<tr>
								<td>1980</td>
								<td>28.98</td>
								<td>
									<button class="c-button">삭제</button>
								</td>
							</tr>
							<tr>
								<td>1980</td>
								<td>28.98</td>
								<td>
									<button class="c-button">삭제</button>
								</td>
							</tr>
							<tr>
								<td>1980</td>
								<td>28.98</td>
								<td>
									<button class="c-button">삭제</button>
								</td>
							</tr>
							<tr>
								<td>1980</td>
								<td>28.98</td>
								<td>
									<button class="c-button">삭제</button>
								</td>
							</tr>
							<tr>
								<td>1980</td>
								<td>28.98</td>
								<td>
									<button class="c-button">삭제</button>
								</td>
							</tr>
							<tr>
								<td>1980</td>
								<td>28.98</td>
								<td>
									<button class="c-button">삭제</button>
								</td>
							</tr>
							<tr>
								<td>1980</td>
								<td>28.98</td>
								<td>
									<button class="c-button">삭제</button>
								</td>
							</tr>
							<tr>
								<td>1980</td>
								<td>28.98</td>
								<td>
									<button class="c-button">삭제</button>
								</td>
							</tr>
							<tr>
								<td>1980</td>
								<td>28.98</td>
								<td>
									<button class="c-button">삭제</button>
								</td>
							</tr>
							<tr>
								<td>1980</td>
								<td>28.98</td>
								<td>
									<button class="c-button">삭제</button>
								</td>
							</tr>
						</tbody>
					</table>
					
					<div class="c-pager">
						<div class="c-paging" id="pricePaging">
							<!-- 페이징 처리되는곳   -->
						</div>
						<div class="c-paging__total">
							<div class="c-paging__total-group">
								Total
							</div>
							<div class="c-paging__total-group" id="totalCnt">0</div>
						</div>
					</div>
				</div>
			</article>
		</section>
		
	</div>
	
</div>
</html>
