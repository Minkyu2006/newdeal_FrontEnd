<!DOCTYPE html>
<html lang="ko"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="layout/default2">

<!-- 사용자 CSS 추가 -->
<th:block layout:fragment="css">
	
</th:block>

<!-- 사용자 스크립트 추가 -->
<th:block layout:fragment="script">
 	<script>
		$(function() {

			logreg(1,"의사결정 시스템","세부별 등록리스트 조회",null);

			callList(1);
			$("#searchBtn").on('click',function(){
				logreg(0,"의사결정 시스템","세부별 등록리스트 조회",null);
				callList(1);
			});

		});

		// 조회
		function callList(page){
			JWT_Get();

			if (accessToken == null && refreshToken == null && insert_id == null) {
				alertCaution("토큰이 만료되었습니다.<BR>다시 로그인해주세요.", 2);
			}else {

				console.log("성능개선사업평가 조회");

				page = page - 1;
				if (page < 0) page = 0

				const perPage = 10;
				const perArea = 5;
				let totCnt = 0;

				const $tablePerformanceList = $('#tablePerformanceList');
				const $totalCnt = $('#totalCnt');

				const params = {
					piFacilityType : $("#piFacilityType").val(),
					piKind : $("#piKind").val(),
					piFacilityName : $("#piFacilityName").val()
				};

				$tablePerformanceList.empty().append('<tr ><td colspan="11" align="center">조회 중</td></tr>');
				$totalCnt.text('0');

				let url = $("#backend_protocol").val() + "://" + $("#backend_url").val() + "/api/performance/list"; // 호출할 백엔드 API
				console.log("url : "+url);
				$.ajax({
					url: url + '?size=' + perPage + '&page=' + page,
					type: 'Get',
					data: params,
					cache: false,
					beforeSend: function (xhr) {
						xhr.setRequestHeader("JWT_AccessToken", accessToken);
						xhr.setRequestHeader("insert_id", insert_id);
					},
					error: function (request) {
						if (request.status === 500) {
							// console.log("500에러 재로그인 해주세요.");
							alertCaution("500에러 재로그인 해주세요.", 2);
						} else {
							// console.log("404에러 재로그인 해주세요.");
							alertCaution("404에러 재로그인 해주세요.", 2);
						}
					},
					success: function (res) {
						console.log("성능개선사업평가 등록 글 출력");
						if (res.status === 200) {
							//화면 출력
							totCnt = res.total_rows;
							$("#performancePaging").jqueryPager({
								pageSize: perPage,
								pageBlock: perArea,
								currentPage: page + 1,
								pageTotal: totCnt,
								clickEvent: 'callList'
							});

							if (totCnt === 0) {
								$tablePerformanceList.empty().append('<tr class="t-c"><td colspan="11" align="center">조회된 데이터가 없습니다.</td></tr>');
								return;
							}

							$totalCnt.text(totCnt);
							let html = '';
							$.each(res.datalist, function (key, value) {
								html += '<tr>';
									html += '<td >'+ '<input type="checkbox" value='+echoNull2Blank(value.piAutoNum)+' />' +'</td>';
									html += '<td >' + echoNull2Blank(value.piFacilityType) + '</td>';
									html += '<td >' + echoNull2Blank(value.piFacilityName) + '</td>';
									html += '<td >' + echoNull2Blank(value.piCompletionYear) + '</td>';
									html += '<td >' + pushComma(echoNull2Blank(value.piErectionCost)) + '</td>';
									html += '<td >' + echoNull2Blank(value.piSafetyLevel) + '</td>';
									html += '<td >' + echoNull2Blank(value.piGoalLevel) + '</td>';
									html += '<td >' + echoNull2Blank(value.piBusinessType) + '</td>';
									html += '<td >' + pushComma(echoNull2Blank(value.piBusinessExpenses)) + '</td>';
									html += '<td ><button class="c-button" onclick="outputMove(\'' + echoNull2Blank(value.piAutoNum) + '\');">비교대안 보기</button></td>';
									html += '<td ><button class="c-button" onclick="del(\'' + echoNull2Blank(value.piAutoNum) + '\');">삭제</button></td>';
								html += '</tr>';
							});
							$tablePerformanceList.html(html);
						}
					}
				});
			}
		}

		function outputMove(autoNum){
			location.href = "/performance/output/" + autoNum;
		}

		// 대안 리스트에서 삭제
		function del(autoNum){
			JWT_Get();

			if (accessToken == null && refreshToken == null && insert_id == null) {
				alertCaution("토큰이 만료되었습니다.<BR>다시 로그인해주세요.", 2);
			}
			// else if (accessToken == null) {
			// 	refreshTokenCookie();
			// }
			else {

				console.log("autoNum : "+autoNum);

				let url;
				url = $("#backend_protocol").val() + "://" + $("#backend_url").val() + "/api/performance/del"; // 호출할 백엔드 API
				console.log("url : "+url);

				const params = {
					autoNum : autoNum
				}

				$.ajax({
					url: url,
					type: 'post',
					data:params,
					cache: false,
					beforeSend: function (xhr) {
						xhr.setRequestHeader("JWT_AccessToken", accessToken);
						xhr.setRequestHeader("insert_id", insert_id);
					},
					error: function (request) {
						if (request.status === 500) {
							// console.log("500에러 재로그인 해주세요.");
							alertCaution("500에러 재로그인 해주세요.", 2);
						} else {
							// console.log("404에러 재로그인 해주세요.");
							alertCaution("404에러 재로그인 해주세요.", 2);
						}
					},
					success: function (res) {
						console.log("리스트출력");
						if (res.status === 200) {
							alertSuccess("삭제가 완료되었습니다.");
							callList(1);
						}
					}
				});
			}
		}

		// // 한글을 지우는 함수
		// function delHangle(evt){
		// 	var objTarget = evt.srcElement || evt.target;
		// 	var _value = event.srcElement.value;
		// 	if(/[ㄱ-ㅎㅏ-ㅡ가-핳]/g.test(_value)) {
		// 		objTarget.value = null;
		// 	}
		// }
		// // 소수점한개로 제한한 실수값입력할수있게하는 함수
		// function isNumberKey(evt) {
		// 	const charCode = (evt.which) ? evt.which : event.keyCode;
		// 	const _value = event.srcElement.value;
		// 	if (event.keyCode < 48 || event.keyCode > 57) {
		// 		if (event.keyCode !== 46) {
		// 			return false;
		// 		}
		// 	}
		// 	// 소수점(.)이 두번 이상 나오지 못하게
		// 	const _pattern0 = /^\d*[.]\d*$/;
		// 	if (_pattern0.test(_value)) {
		// 		if (charCode === 46) {
		// 			return false;
		// 		}
		// 	}
		// 	// 소수점 둘째자리까지만 입력가능
		// 	const _pattern2 = /^\d*[.]\d{2}$/;
		// 	if (_pattern2.test(_value)) {
		// 		return false;
		// 	}
		// }

	</script>
</th:block>

<div layout:fragment="content" class="content">
	<input type="hidden" id="backend_url" th:value="${backend_url}" />
	<input type="hidden" id="backend_protocol" th:value="${backend_protocol}" />
	<div class="content__inner">
		<section class="section">
			<article class="article">
				<div class="article__head">
					<h2 class="article__heading" style="font-size: 27px">성능개선 사업평가 등록 글 조회</h2>
				</div>
				<div class="article__body">
					<div class="l-float-heading">
						<div class="l-float-heading--left">
							<h4 class="article__head" style="color: red">해당 리스트는 우수대안을 기준으로 출력됩니다.</h4>
						</div>
					</div>
					<table class="c-table">
						<colgroup>
							<col style="width: 100px;" />
							<col />
							<col style="width: 100px;" />
							<col />
							<col style="width: 100px;" />
							<col />
							<col style="width: 60px;" />
						</colgroup>
						<tbody>
							<tr>
								<th>시설유형</th>
								<td>
									<div class="c-select">
										<select id="piFacilityType" class="c-select__input" >
											<option value="">유형을 선택해주세요.</option>
											<option value="교량">교량</option>
											<option value="보도육교">보도육교</option>
											<option value="터널">터널</option>
											<option value="지하차도">지하차도</option>
											<option value="옹벽">옹벽</option>
											<option value="절토사면">절토사면</option>
										</select>
									</div>
								</td>
								<th>종별구분</th>
								<td>
									<div class="c-select">
										<select id="piKind" class="c-select__input" >
											<option value="">종별을 선택해주세요.</option>
											<option value="1종">1종</option>
											<option value="2종">2종</option>
											<option value="3종">3종</option>
											<option value="기타">기타</option>
										</select>
									</div>
								</td>
								<th>시설명</th>
								<td>
									<div class="c-text">
										<input type="text" id="piFacilityName" class="c-text__input" />
									</div>
								</td>
								<td>
									<button class="c-button c-button--point" id="searchBtn">조회</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</article>
			
			<article class="article">
				<div class="article__body">
					<table class="c-table">
						<colgroup>
							<col style="width: 40px;" />
							<col style="width: 100px;" />
							<col style="width: 100px;" />
							<col style="width: 80px;" />
							<col style="width: 150px;" />
							<col style="width: 70px;" />
							<col style="width: 120px;" />
							<col style="width: 80px;" />
							<col style="width: 150px;" />
							<col style="width: 110px;" />
							<col style="width: 60px;" />
						</colgroup>
						<thead>
							<tr>
								<th>선택</th>
								<th>시설유형</th>
								<th>시설명</th>
								<th>준공연도</th>
								<th>취득원가</th>
								<th>안전등급</th>
								<th>목표 안전등급</th>
								<th>사업유형</th>
								<th>사업비용</th>
								<th></th>
								<th></th>
							</tr>
						</thead>
						<tbody id="tablePerformanceList">
						</tbody>
					</table>
					
					<div class="c-pager">
						<div class="c-paging" id="performancePaging">
							<!-- 페이징 처리되는곳   -->
						</div>
						<div class="c-paging__total">
							<div class="c-paging__total-group">
								Total
							</div>
							<div class="c-paging__total-group" id="totalCnt">0</div>
						</div>
					</div>
				</div>
			</article>
		</section>
		
	</div>
	
</div>
</html>
